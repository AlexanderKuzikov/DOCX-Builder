<!-- Updated layout, original: index.html [file:11] -->
<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>DOCX Orchestrator</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <!-- 1. ГЕНЕРАТОР -->
        <div class="panel">
            <div class="panel-header">
                <h3>Создание структуры папок</h3>
                <button class="select-all-toggle" type="button" onclick="toggleAllCases()">
                    <span class="select-all-checkbox" aria-hidden="true"></span>
                    <span class="select-all-label">Выбрать все / Снять</span>
                </button>
            </div>

            <div class="input-row" style="margin-bottom: 8px;">
                <input type="text" id="docTypeInput"
                    placeholder="Введите название документа (например: Ходатайство об отложении)">
                <button class="btn-create" type="button" onclick="createStructure()">Создать</button>
            </div>

            <div class="tags-wrapper" id="casesContainer"></div>
        </div>

        <!-- 2. ТУЛБАР -->
        <div class="toolbar">
            <div class="toolbar-group">
                <button class="btn" type="button" onclick="runRenamer()">
                    <span class="btn-icon icon-rename" aria-hidden="true"></span>
                    <span class="btn-label">Переименовать</span>
                </button>
                <button class="btn btn-primary" type="button" onclick="runBuildAll()">
                    <span class="btn-icon icon-build-all" aria-hidden="true"></span>
                    <span class="btn-label">Собрать всё</span>
                </button>
            </div>

            <div class="toolbar-group">
                <button class="btn" type="button" onclick="loadFolders()">
                    <span class="btn-icon icon-refresh" aria-hidden="true"></span>
                    <span class="btn-label">Обновить</span>
                </button>
                <button class="btn" type="button" onclick="toggleSettings()">
                    <span class="btn-icon icon-settings" aria-hidden="true"></span>
                    <span class="btn-label">Настройки</span>
                </button>
                <button class="btn btn-danger" type="button" onclick="shutdownServer()" title="Остановить сервер">
                    <span class="btn-icon icon-exit" aria-hidden="true"></span>
                    <span class="btn-label">Выход</span>
                </button>
            </div>
        </div>

        <!-- 3. ТАБЛИЦА -->
        <div class="panel" style="padding: 0; overflow: hidden;">
            <table>
                <thead>
                    <tr>
                        <th style="width: 50%;">Папка проекта</th>
                        <th style="width: 15%;">Статус</th>
                        <th style="width: 20%;">Результат</th>
                        <th style="width: 15%; text-align: right;">Действия</th>
                    </tr>
                </thead>
                <tbody id="folderTable"></tbody>
            </table>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal">
        <div class="modal-content">
            <h2 class="modal-title">Настройки</h2>

            <p class="modal-label">Путь к рабочей папке (IN):</p>
            <input type="text" id="settingsInDir" class="modal-input">

            <div class="modal-actions">
                <button class="btn" type="button" onclick="toggleSettings()">Отмена</button>
                <button class="btn btn-primary" type="button" onclick="saveSettings()">Сохранить</button>
            </div>
        </div>
    </div>

    <script>
        async function api(url, method = 'GET', body = null) {
            try {
                const opts = {
                    method,
                    headers: { 'Content-Type': 'application/json' }
                };
                if (body) {
                    opts.body = JSON.stringify(body);
                }
                return await (await fetch('/api' + url, opts)).json();
            } catch (e) {
                console.error(e);
                return {};
            }
        }

        let selectedCases = new Set();

        async function init() {
            const cases = await api('/cases');
            if (cases && cases.length) {
                renderCases(cases);
            }
            loadFolders();
            loadSettings();
        }

        function renderCases(cases) {
            const container = document.getElementById('casesContainer');
            container.innerHTML = cases.map(c => `
        <button class="tag selected" type="button" onclick="toggleCase(this, '${c}')">
            ${c}
        </button>
    `).join('');
            cases.forEach(c => selectedCases.add(c));
        }

        function toggleCase(el, name) {
            if (selectedCases.has(name)) {
                selectedCases.delete(name);
                el.classList.remove('selected');
            } else {
                selectedCases.add(name);
                el.classList.add('selected');
            }
        }

        function toggleAllCases() {
            const tags = document.querySelectorAll('.tag');
            const allSelected = tags.length === document.querySelectorAll('.tag.selected').length;

            tags.forEach(t => t.classList.toggle('selected', !allSelected));

            if (allSelected) {
                selectedCases.clear();
            } else {
                document.querySelectorAll('.tag').forEach(t => selectedCases.add(t.innerText));
            }
        }

        async function loadFolders() {
            const folders = await api('/folders');
            const tbody = document.getElementById('folderTable');

            if (!folders || !folders.length) {
                tbody.innerHTML = `
            <tr>
                <td colspan="4" class="table-empty">
                    Нет папок
                </td>
            </tr>
        `;
                return;
            }

            tbody.innerHTML = folders.map(f => {
                let status = '<span class="dot dot-empty"></span> <span class="status-label status-empty">Пусто</span>';

                if (!f.isEmpty) {
                    status = f.isRenamed
                        ? '<span class="dot dot-ready"></span> <span class="status-label status-ready">Готов</span>'
                        : '<span class="dot dot-raw"></span> <span class="status-label status-raw">Переименовать</span>';
                }

                let result = '<span class="result-placeholder">—</span>';
                if (f.isBuilt) {
                    result = `
                <a class="file-link" onclick="openFile('${f.name}')">
                    <span class="file-icon" aria-hidden="true"></span>
                    <span class="file-label">DOCX</span>
                </a>
            `;
                }

                const buildBtn = !f.isEmpty
                    ? `
                <button
                    class="btn-mini btn-mini-build"
                    type="button"
                    onclick="buildOne('${f.name}')"
                    title="Собрать"
                >
                    <span class="btn-mini-icon icon-build-one" aria-hidden="true"></span>
                </button>
            `
                    : '';

                return `
            <tr>
                <td>
                    <button class="folder-cell" type="button" onclick="openFolder('${f.name}')">
                        <span class="folder-icon" aria-hidden="true"></span>
                        <span class="folder-name">${f.name}</span>
                    </button>
                </td>
                <td>${status}</td>
                <td>${result}</td>
                <td style="text-align:right;">
                    <div class="row-actions">
                        ${buildBtn}
                        <button
                            class="btn-mini btn-mini-open"
                            type="button"
                            onclick="openFolder('${f.name}')"
                            title="Открыть папку"
                        >
                            <span class="btn-mini-icon icon-open-folder" aria-hidden="true"></span>
                        </button>
                    </div>
                </td>
            </tr>
        `;
            }).join('');
        }

        async function createStructure() {
            const docType = document.getElementById('docTypeInput').value.trim();
            if (!docType) {
                alert('Введите название!');
                return;
            }
            await api('/create', 'POST', { docType, selectedCases: Array.from(selectedCases) });
            loadFolders();
        }

        async function runRenamer() {
            await api('/run/renamer', 'POST');
            loadFolders();
        }

        async function buildOne(name) {
            if (confirm(`Собрать "${name}"?`)) {
                await api('/run/builder', 'POST', { folderName: name });
                loadFolders();
            }
        }

        async function runBuildAll() {
            if (confirm('Собрать все папки?')) {
                await api('/run/builder', 'POST');
                loadFolders();
            }
        }

        async function openFolder(name) {
            await api('/open', 'POST', { name, isFile: false });
        }

        async function openFile(name) {
            await api('/open', 'POST', { name, isFile: true });
        }

        async function shutdownServer() {
            if (!confirm('Выключить сервер?')) return;
            await api('/shutdown', 'POST');
            document.body.innerHTML = `
        <div class="shutdown-screen">
            <h1>Сервер выключен</h1>
        </div>
    `;
            setTimeout(() => window.close(), 1000);
        }

        function toggleSettings() {
            const modal = document.getElementById('settingsModal');
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
        }

        async function loadSettings() {
            const res = await api('/settings');
            if (res.inDir) {
                document.getElementById('settingsInDir').value = res.inDir;
            }
        }

        async function saveSettings() {
            const inDir = document.getElementById('settingsInDir').value;
            const res = await api('/settings', 'POST', { inDir });
            if (res.error) {
                alert(res.error);
            } else {
                toggleSettings();
                loadFolders();
            }
        }

        init();
    </script>
</body>

</html>