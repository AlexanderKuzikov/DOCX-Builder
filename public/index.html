<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>DOCX Orchestrator</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div class="container">

        <!-- 1. –ì–ï–ù–ï–†–ê–¢–û–† -->
        <div class="panel">
            <div class="panel-header">
                <h3>–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–∞–ø–æ–∫</h3>
                <span style="font-size:11px; color:#666; cursor:pointer;" onclick="toggleAllCases()">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ /
                    –°–Ω—è—Ç—å</span>
            </div>

            <div class="input-row" style="margin-bottom: 8px;">
                <input type="text" id="docTypeInput"
                    placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –•–æ–¥–∞—Ç–∞–π—Å—Ç–≤–æ –æ–± –æ—Ç–ª–æ–∂–µ–Ω–∏–∏)">
                <button class="btn-create" onclick="createStructure()">–°–æ–∑–¥–∞—Ç—å</button>
            </div>

            <div class="tags-wrapper" id="casesContainer"></div>
        </div>

        <!-- 2. –¢–£–õ–ë–ê–† -->
        <div class="toolbar">
            <div class="toolbar-group">
                <button class="btn" onclick="runRenamer()">
                    ü™Ñ –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å
                </button>
                <button class="btn btn-primary" onclick="runBuildAll()">
                    üèóÔ∏è –°–æ–±—Ä–∞—Ç—å –≤—Å—ë
                </button>
            </div>

            <div class="toolbar-group">
                <button class="btn" onclick="loadFolders()">
                    üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                </button>
                <button class="btn" onclick="toggleSettings()">
                    ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                </button>
                <button class="btn btn-danger" onclick="shutdownServer()" title="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä">
                    ‚èª –í—ã—Ö–æ–¥
                </button>
            </div>
        </div>

        <!-- 3. –¢–ê–ë–õ–ò–¶–ê -->
        <div class="panel" style="padding: 0; overflow: hidden;">
            <table>
                <thead>
                    <tr>
                        <th style="width: 50%;">–ü–∞–ø–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞</th>
                        <th style="width: 15%;">–°—Ç–∞—Ç—É—Å</th>
                        <th style="width: 20%;">–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                        <th style="width: 15%; text-align: right;">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="folderTable"></tbody>
            </table>
        </div>

    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal">
        <div class="modal-content">
            <h2 style="margin-top:0; font-size:14px; color:#fff; font-weight:600; text-transform:uppercase;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏
            </h2>
            <p style="color:#888; font-size:12px; margin-bottom:5px;">–ü—É—Ç—å –∫ —Ä–∞–±–æ—á–µ–π –ø–∞–ø–∫–µ (IN):</p>

            <input type="text" id="settingsInDir"
                style="width:100%; box-sizing:border-box; border-radius:3px; margin-bottom:15px; padding:6px;">

            <div style="display:flex; justify-content:flex-end; gap:8px;">
                <button class="btn" onclick="toggleSettings()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        async function api(url, method = 'GET', body = null) {
            try {
                const opts = { method, headers: { 'Content-Type': 'application/json' } };
                if (body) opts.body = JSON.stringify(body);
                return await (await fetch('/api' + url, opts)).json();
            } catch (e) { console.error(e); return {}; }
        }

        let selectedCases = new Set();

        async function init() {
            const cases = await api('/cases');
            if (cases && cases.length) renderCases(cases);
            loadFolders();
            loadSettings();
        }

        function renderCases(cases) {
            const container = document.getElementById('casesContainer');
            container.innerHTML = cases.map(c => `
            <div class="tag selected" onclick="toggleCase(this, '${c}')">${c}</div>
        `).join('');
            cases.forEach(c => selectedCases.add(c));
        }

        function toggleCase(el, name) {
            if (selectedCases.has(name)) { selectedCases.delete(name); el.classList.remove('selected'); }
            else { selectedCases.add(name); el.classList.add('selected'); }
        }

        function toggleAllCases() {
            const tags = document.querySelectorAll('.tag');
            const allSelected = tags.length === document.querySelectorAll('.tag.selected').length;
            tags.forEach(t => t.classList.toggle('selected', !allSelected));
            if (allSelected) selectedCases.clear();
            else document.querySelectorAll('.tag').forEach(t => selectedCases.add(t.innerText));
        }

        async function loadFolders() {
            const folders = await api('/folders');
            const tbody = document.getElementById('folderTable');

            if (!folders || !folders.length) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:#555;">–ù–µ—Ç –ø–∞–ø–æ–∫</td></tr>';
                return;
            }

            tbody.innerHTML = folders.map(f => {
                let status = '<span class="dot dot-empty"></span> <span style="color:#666">–ü—É—Å—Ç–æ</span>';
                if (!f.isEmpty) {
                    status = f.isRenamed
                        ? '<span class="dot dot-ready"></span> <span style="color:#fff">–ì–æ—Ç–æ–≤</span>'
                        : '<span class="dot dot-raw"></span> <span style="color:#dcb67a">Rename</span>';
                }

                let result = '<span style="color:#444">‚Äî</span>';
                if (f.isBuilt) result = `<a class="file-link" onclick="openFile('${f.name}')">üìÑ DOCX</a>`;

                let buildBtn = !f.isEmpty ? `<button class="btn-mini btn-mini-build" onclick="buildOne('${f.name}')" title="–°–æ–±—Ä–∞—Ç—å" style="font-size:10px;">üî®</button>` : '';

                return `
                <tr>
                    <td><div style="display:flex; align-items:center;"><span class="folder-icon">üìÇ</span> <span style="cursor:pointer;" onclick="openFolder('${f.name}')">${f.name}</span></div></td>
                    <td>${status}</td>
                    <td>${result}</td>
                    <td style="text-align:right;">
                        <div style="display:inline-flex; gap:4px;">
                            ${buildBtn} 
                            <button class="btn-mini" onclick="openFolder('${f.name}')" title="–û—Ç–∫—Ä—ã—Ç—å –ø–∞–ø–∫—É" style="font-size:10px;">‚ÜóÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        async function createStructure() {
            const docType = document.getElementById('docTypeInput').value;
            if (!docType) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!');
            await api('/create', 'POST', { docType, selectedCases: Array.from(selectedCases) });
            loadFolders();
        }
        async function runRenamer() { await api('/run/renamer', 'POST'); loadFolders(); }
        async function buildOne(name) { if (confirm(`–°–æ–±—Ä–∞—Ç—å "${name}"?`)) await api('/run/builder', 'POST', { folderName: name }); loadFolders(); }
        async function runBuildAll() { if (confirm('–°–æ–±—Ä–∞—Ç—å –≤—Å–µ –ø–∞–ø–∫–∏?')) await api('/run/builder', 'POST'); loadFolders(); }
        async function openFolder(name) { await api('/open', 'POST', { name, isFile: false }); }
        async function openFile(name) { await api('/open', 'POST', { name, isFile: true }); }

        async function shutdownServer() {
            if (!confirm('–í—ã–∫–ª—é—á–∏—Ç—å —Å–µ—Ä–≤–µ—Ä?')) return;
            await api('/shutdown', 'POST');
            document.body.innerHTML = '<div style="display:flex;height:100vh;justify-content:center;align-items:center;color:#666;"><h1>–°–µ—Ä–≤–µ—Ä –≤—ã–∫–ª—é—á–µ–Ω</h1></div>';
            setTimeout(() => window.close(), 1000);
        }

        function toggleSettings() { document.getElementById('settingsModal').style.display = document.getElementById('settingsModal').style.display === 'flex' ? 'none' : 'flex'; }
        async function loadSettings() { const res = await api('/settings'); if (res.inDir) document.getElementById('settingsInDir').value = res.inDir; }
        async function saveSettings() {
            const inDir = document.getElementById('settingsInDir').value;
            const res = await api('/settings', 'POST', { inDir });
            if (res.error) alert(res.error); else { toggleSettings(); loadFolders(); }
        }

        init();
    </script>

</body>

</html>